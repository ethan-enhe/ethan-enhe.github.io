---
layout:     post
title:      ç‚¹åˆ†æ²»æ°´é¢˜
subtitle:   é‡äº‹ä¸å†³ç‚¹åˆ†æ²»
date:       2021-12-05
author:     ethan-zhou
header-img: img/post-bg-desk.jpg
catalog: true
tags:
    - å›¾è®º
    - æ ‘
---

## CF1260F Colored Tree

### é¢˜æ„

ä¸€é¢—æœ‰ n ä¸ªèŠ‚ç‚¹çš„æ ‘ï¼Œæ¯ä¸ªèŠ‚ç‚¹ v æœ‰é¢œè‰² $c_v$ï¼Œè¿™ä¸ªæŸ“è‰²æ–¹æ¡ˆçš„æƒå€¼ä¸º $\sum\limits_{u,v\in[1,n],v>u,c_v=c_u}\operatorname{dis}{(u,v)}$ã€‚

çŽ°åœ¨çŸ¥é“æ¯ä¸ªèŠ‚ç‚¹ v å¯ä»¥æŸ“æˆ $[l_v,r_v]$ ä¸­ä»»æ„é¢œè‰²ï¼Œæ±‚æ‰€æœ‰æŸ“è‰²æ–¹æ¡ˆçš„æƒå€¼ä¹‹å’Œã€‚

$n\le 10^5$ï¼Œæ—¶é™ 2.5 ç§’ã€‚

### æ€è·¯

ä¸€ä¸ªæ˜¾ç„¶çš„æƒ³æ³•æ˜¯è€ƒè™‘æ¯ä¸€æ¡è·¯å¾„çš„è´¡çŒ®ï¼ŒäºŽæ˜¯è‡ªç„¶çš„æƒ³åˆ°ç‚¹åˆ†æ²»ã€‚è€ƒè™‘è¿‡åˆ†æ²»ä¸­å¿ƒä¸€æ¡è·¯å¾„çš„è´¡çŒ®ï¼ˆä¸ºæ–¹ä¾¿èµ·è§ï¼ŒåŽæ–‡éƒ½ç®—çš„æ˜¯æƒå€¼æœŸæœ›ï¼‰ã€‚

![](https://pic.imgdb.cn/item/61ac9cbf2ab3f51d91065489.jpg)

æ˜¾ç„¶è´¡çŒ®ä¸ºï¼š

$$
(d_u+d_v)\frac{|[l_u,r_u]\cap[l_v,r_v]|}{|[l_u,r_u]|\cdot|[l_v,r_v]|}
$$

æˆ‘ä»¬å¯ä»¥ç»´æŠ¤ä¸€ä¸ªçº¿æ®µæ ‘ï¼Œåœ¨æœåˆ° u çš„æ—¶ï¼ŒæŠŠ $[l_u,r_u]$ åŒºé—´åŠ  $\frac{d_u}{\|[l_u,r_u]\|}$ã€‚æœåˆ° v æ—¶ï¼ŒæŠŠ $[l_v,r_v]$ åŒºé—´çš„å’Œï¼Œä¹˜ä»¥ $\frac1{\|[l_v,r_v]\|}$ï¼ŒåŠ åˆ°ç­”æ¡ˆé‡Œå³å¯ï¼Œè¿™æ ·æˆ‘ä»¬å°±è§£å†³äº†ä¸Šå¼ä¸­ç¬¬ä¸€é¡¹ã€‚

å¯¹äºŽç¬¬äºŒé¡¹ï¼Œå¯ä»¥åç€åšä¸€éï¼Œä¹Ÿå¯ä»¥å†å¼€ä¸€ä¸ªå¦å¤–å«ä¹‰çš„çº¿æ®µæ ‘ï¼Œæ€Žä¹ˆæžéƒ½è¡Œã€‚

å¤æ‚åº¦ $\mathcal{O}(n\log^2 n)$ã€‚

é¢˜è§£æä¾›äº†ä¸€ä¸ªä¸ç”¨ç‚¹åˆ†æ²»çš„åšæ³•ï¼Œå¤æ‚åº¦ä¸€æ ·ï¼Œåœ¨æ­¤å…ˆä¸è¯´ï¼Œå› ä¸ºæˆ‘æ²¡è¯»æ‡‚ã€‚

### ä»£ç 

```cpp
const ll INF=1e18,P=1e9+7;

inline ll mod(ll x){
    if(x>=P)return x-P;
    if(x<0)return x+P;
    return x;
}
inline ll qpow(ll x,ll y){ll res=1;while(y){if(y&1)res=res*x%P;x=x*x%P;y>>=1;}return res;}

const ll MXN=1e5+5,MNMEM=5e4;

ll n,ans,all=1,arr[MXN],lh[MXN],rh[MXN];
struct tarr{
    ll d[MXN],di[MXN];
    inline void suf(ll x,ll y){
        ll yi=y*x%P;
        for(;x<MXN;x+=x&(-x)){
            d[x]=mod(d[x]+y);
            di[x]=mod(di[x]+yi);
        }
    }
    inline ll pre(ll l){
        ll s=0,si=0;
        for(ll x=l;x;x^=x&(-x)){
            s=mod(s+d[x]);
            si=mod(si+di[x]);
        }
        return (s*(l+1)-si)%P;
    }
    inline void clr(ll x){for(;x<MXN;x+=x&(-x))d[x]=di[x]=0;}
    inline void mem(){
        memset(d,0,sizeof(d));
        memset(di,0,sizeof(di));
    }
}c,v;

vector<ll> t[MXN];
ll sz[MXN];bool vis[MXN];
inline void dfssz(ll p,ll fa){
    sz[p]=1;
    for(ll &nx:t[p])
        if(!vis[nx] && nx!=fa){
            dfssz(nx,p);
            sz[p]+=sz[nx];
        }
}
inline ll dfsrt(ll p,ll fa,ll tot){
    bool f=(sz[p]<<1)>=tot;
    for(ll &nx:t[p])
        if(!vis[nx] && nx!=fa){
            ll tmp=dfsrt(nx,p,tot);
            if(tmp)return tmp;
            f&=(sz[nx]<<1)<=tot;
        }
    return f?p:0;
}
inline void dfsm(ll p,ll fa,ll dpth){
    if(dpth<0){
        c.clr(lh[p]),c.clr(rh[p]+1);
        v.clr(lh[p]),v.clr(rh[p]+1);
    }
    else{
        ll tmp=dpth*arr[p]%P;
        c.suf(lh[p],arr[p]),c.suf(rh[p]+1,-arr[p]);
        v.suf(lh[p],tmp),v.suf(rh[p]+1,-tmp);
    }
    for(ll &nx:t[p])
        if(!vis[nx] && nx!=fa)
            dfsm(nx,p,dpth+1);
}
inline void dfsq(ll p,ll fa,ll dpth){
    ans=(ans+(dpth*(c.pre(rh[p])-c.pre(lh[p]-1))+v.pre(rh[p])-v.pre(lh[p]-1))%P*arr[p])%P;
    for(ll &nx:t[p])
        if(!vis[nx] && nx!=fa)
            dfsq(nx,p,dpth+1);
}

inline void dfz(ll p){
    dfssz(p,0);
    ll tsz=sz[p];
    vis[p=dfsrt(p,0,tsz)]=1;

    c.suf(lh[p],arr[p]),c.suf(rh[p]+1,-arr[p]);
    for(ll &nx:t[p])
        if(!vis[nx]){
            dfsq(nx,0,1);
            dfsm(nx,0,1);
        }
    if(tsz>MNMEM)c.mem(),v.mem();
    else dfsm(p,0,-INF);
    for(ll &nx:t[p])
        if(!vis[nx])
            dfz(nx);
}

int main(){
    scanf("%lld",&n);
    for(int i=1;i<=n;i++){
        scanf("%lld%lld",lh+i,rh+i);
        arr[i]=qpow(rh[i]-lh[i]+1,P-2);
        all=all*(rh[i]-lh[i]+1)%P;
    }
    for(ll i=1,ts,tt;i<n;i++){
        scanf("%lld%lld",&ts,&tt);
        t[ts].pb(tt);
        t[tt].pb(ts);
    }
    dfz(1);

    printf("%lld\n",all*(ans+P)%P);
    return 0;
}
```

## æ ‘ä¸Šæ¸¸æˆ

å®žåœ¨æ‰¾ä¸åˆ°å•¥ç‚¹åˆ†æ²»å¥½é¢˜äº†ï¼Œåªèƒ½ç”¨ç‚¹åˆ†æ²»ç¡¬åšè¿™é¢˜ã€‚

### é¢˜æ„

æ ‘ä¸Šæ¯ä¸ªç‚¹æœ‰é¢œè‰²ï¼Œå®šä¹‰ $\operatorname{s}{(i,j)}$ ä¸º i åˆ° j è·¯å¾„é¢œè‰²æ•°ï¼Œå¯¹äºŽ $i\in[1,n]$ æ±‚ $ans_i=\sum\limits_{j\in[1,n]}\operatorname{s}{(i,j)}$ã€‚

$n\le10^5$ï¼Œæ—¶é™ 1 ç§’ã€‚

### æ€è·¯

è¿™é¢˜æ€Žä¹ˆåšéƒ½è¡Œï¼Œæœ‰å¥½å¤šçº¿æ€§çš„åšæ³•ï¼Œä½†æ˜¯æˆ‘ä»¬è¦æœ‰æ‹¿ä¸‹æœ€åŠ£è§£çš„è¿½æ±‚ï¼Œä¸ºäº†å®žçŽ°è¿™ä¸€ç›®æ ‡ï¼Œè€ƒè™‘æ·€ç²‰è´¨çš„åšæ³•ã€‚

![](https://pic.imgdb.cn/item/61acbc542ab3f51d911c8774.jpg)

ä¸Šå›¾ä¸­ï¼Œè“è‰²å¤§ä¸‰è§’è¡¨ç¤ºæ‰€æœ‰æœè¿‡çš„å­æ ‘ï¼Œv æ˜¯æ­£åœ¨æŸ¥è¯¢çš„ç‚¹ï¼Œå¯¹äºŽæ‰€æœ‰è¿‡åˆ†æ²»ä¸­å¿ƒ rt çš„è·¯å¾„ $u \sim v$ï¼Œè€ƒè™‘çº¢è‰²å¯¹å“ªäº›è·¯å¾„æœ‰è´¡çŒ®ï¼Œå‘çŽ°æœ‰ä¸¤ç§æƒ…å†µï¼š

- u åœ¨æŸä¸ªçº¢è‰²èŠ‚ç‚¹çš„å­æ ‘ä¸­
- $v \sim rt$ ä¸Šæœ‰çº¢è‰²èŠ‚ç‚¹

å®šä¹‰ hasc è¡¨ç¤ºï¼ˆè“è‰²å­æ ‘ä¸­ï¼‰åˆ° rt çš„è·¯å¾„ä¸Šæœ‰çº¢è‰²çš„ç‚¹æ•°ï¼Œå½“æˆ‘ä¿®æ”¹èŠ‚ç‚¹ u çš„æ—¶å€™ï¼Œå¦‚æžœå‘çŽ°è·¯å¾„ $rt\sim u$ ä¸Šæ²¡æœ‰çº¢è‰²çš„è¯ï¼Œæˆ‘å°± $hasc\gets hasc + \text{u å­æ ‘å¤§å°}$ã€‚

åœ¨æŸ¥è¯¢æ—¶,ä¸€å¼€å§‹çš„ç­”æ¡ˆä¸º hasc ï¼Œdfs çš„è¿‡ç¨‹ä¸­ï¼Œå¦‚æžœç¬¬ä¸€æ¬¡ç¢°åˆ°ä¸€ä¸ªçº¢è‰²ç‚¹ï¼ˆè¿™ä¸ªç‚¹çš„ç¥–å…ˆä¸Šæ²¡æœ‰çº¢è‰²ç‚¹ï¼‰ï¼Œé‚£ä¹ˆå¯¹äºŽå…¶å­æ ‘ï¼Œçº¢è‰²çš„è´¡çŒ®å°±å¢žåŠ äº†è“è‰²åŒºåŸŸçš„ç‚¹æ•°ï¼Œå›žæº¯çš„æ—¶å€™å†æ’¤é”€å³å¯ã€‚

å› ä¸ºæ¯ä¸ªç‚¹åªæœ‰ä¸€ä¸ªé¢œè‰²ï¼Œæ‰€ä»¥å…¶å®žä¸Šè¿°çš„è¿‡ç¨‹æ˜¯å¯ä»¥åœ¨ dfs ä¸­å¯¹æ¯ä¸ªé¢œè‰²åŒæ—¶è¿›è¡Œçš„ã€‚

å¤æ‚åº¦ $O(n\log n)$ã€‚

æœ‰ä¸å°‘ç»†èŠ‚ï¼Œå°¤å…¶æ˜¯åœ¨åˆ†æ²»ä¸­å¿ƒçš„å¤„ç†ä¸Šï¼Œä¸å»ºè®®å®žçŽ°ã€‚

### ä»£ç 

```cpp
#include <bits/stdc++.h>

using namespace std;
typedef long long ll;
const ll MXN = 1e5 + 5;
ll n, c[MXN];
vector<ll> g[MXN];

bool vis[MXN];
ll sz[MXN];
void dfssz(ll p, ll fa) {
    sz[p] = 1;
    for (ll nx : g[p])
        if (!vis[nx] && nx != fa) {
            dfssz(nx, p);
            sz[p] += sz[nx];
        }
}
ll dfsrt(ll p, ll fa, ll tot) {
    bool f = (sz[p] << 1) >= tot;
    for (ll nx : g[p])
        if (!vis[nx] && nx != fa) {
            ll nxr = dfsrt(nx, p, tot);
            if (nxr) return nxr;
            f &= (sz[nx] << 1) <= tot;
        }
    return f ? p : 0;
}

ll instk[MXN], ans[MXN];
//åˆ°æ ¹è·¯å¾„ä¸Šæœ‰è¿™ä¸ªé¢œè‰²çš„èŠ‚ç‚¹æ•°
ll hasc[MXN], curans;
void dfsm(ll p, ll fa, ll tp) {
    if (!instk[c[p]]++) {
        hasc[c[p]] += tp * sz[p];
        curans += tp * sz[p];
    }
    for (ll nx : g[p])
        if (!vis[nx] && nx != fa) dfsm(nx, p, tp);
    --instk[c[p]];
}
void dfsq(ll p, ll fa, ll outofsubt) {
    if (!instk[c[p]]++) curans += outofsubt - hasc[c[p]];
    ans[p] += curans;
    for (ll nx : g[p])
        if (!vis[nx] && nx != fa) dfsq(nx, p, outofsubt);
    if (!--instk[c[p]]) curans -= outofsubt - hasc[c[p]];
}
void dfz(ll p) {
    dfssz(p, 0);
    p = dfsrt(p, 0, sz[p]);
    vis[p] = 1;
    dfssz(p, 0);

    instk[c[p]] = 1;
    for (ll nx : g[p])
        if (!vis[nx]) dfsm(nx, p, 1);
    //åˆ°æ ¹
    ans[p] += curans + sz[p];
    for (ll nx : g[p])
        if (!vis[nx]) {
            dfsm(nx, p, -1);
            curans += sz[p] - sz[nx];
            dfsq(nx, p, sz[p] - sz[nx]);
            curans -= sz[p] - sz[nx];
            dfsm(nx, p, 1);
        }
    for (ll nx : g[p])
        if (!vis[nx]) dfsm(nx, p, -1);
    instk[c[p]] = 0;
    for (ll nx : g[p])
        if (!vis[nx]) dfz(nx);
}
int main() {
    scanf("%lld", &n);
    for (ll i = 1; i <= n; i++) scanf("%lld", c + i);
    for (ll i = 1; i < n; i++) {
        ll u, v;
        scanf("%lld%lld", &u, &v);
        g[v].push_back(u);
        g[u].push_back(v);
    }
    dfz(1);
    for (ll i = 1; i <= n; i++) printf("%lld\n", ans[i]);
    return 0;
}
```

## P3060 [USACO12NOV]Balanced Trees G

### é¢˜æ„

ç»™å‡ºä¸€æ£µæ ‘ï¼Œæ¯ä¸ªèŠ‚ç‚¹ä¸Šæœ‰ä¸€ä¸ªæ‹¬å·ï¼Œå¯¹äºŽæ‰€æœ‰æ‹¬å·åŒ¹é…çš„è·¯å¾„ï¼Œæ±‚å…¶åµŒå¥—å±‚æ•°æœ€å¤§å€¼ã€‚

### æ€è·¯

æ‹¬å·åŒ¹é…æ¯”è¾ƒæœ‰ç”¨çš„æ€§è´¨å°±æ˜¯æŠŠ `{` çœ‹æˆ 1ï¼Œ`}` çœ‹æˆ -1ï¼Œæœ€ç»ˆåºåˆ—çš„å‰ç¼€å’Œ $pre_i$éƒ½å¤§äºŽç­‰äºŽ 0ï¼Œå¹¶ä¸”æ€»å’Œ s ä¸º 0.

è€Œæœ€å¤§åµŒå¥—å±‚æ•°åˆ™ç­‰äºŽå‰ç¼€å’Œçš„æœ€å¤§å€¼ã€‚

è€ƒè™‘æŠŠä¸¤ä¸ªæ‹¬å·åºåˆ—åˆèµ·æ¥ï¼š

$$
\begin{aligned}
str&=str1 + str2\cr
s&=s1+s2\cr
\max{(pre_i)}&=\max{(\max{(pre1_i)},s1+\max{(pre2_i)})}\cr
\min{(pre_i)}&=\min{(\min{(pre1_i)},s1+\min{(pre2_i)})}
\end{aligned}
$$

æ‰€ä»¥åªéœ€åœ¨ç¬¬ä¸€æ¬¡ dfs æ—¶ï¼Œåˆ¤æ–­å¦‚æžœå‰åŠæ®µ pre çš„æœ€å°å€¼å¤§äºŽç­‰äºŽ 0ï¼Œå°±æŠŠå‰åŠæ®µ pre çš„æœ€å¤§å€¼æ‰“åˆ°ä¸€ä¸ªæ¡¶é‡Œ s1 çš„ä½ç½®ï¼ŒæŸ¥è¯¢å°±éšä¾¿æžæžå³å¯ã€‚

æ²¡æ—¶é—´å®žçŽ°äº†ï¼Œæˆ‘å¦ˆå‚¬æˆ‘ç¡è§‰ðŸ˜¡ã€‚

